<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>WebSocket Chat</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f4f4f4; }
    #messages { list-style: none; padding: 0; max-height: 300px; overflow-y: auto; }
    li { margin-bottom: 5px; background: #fff; padding: 8px; border-radius: 5px; display: flex; align-items: center; gap: 10px; }
    input[type="text"], input[type="file"] { padding: 6px; margin-right: 5px; }
    button { padding: 6px 10px; }
    .avatar { width: 32px; height: 32px; border-radius: 50%; }
    #avatarPreview { width: 40px; height: 40px; border-radius: 50%; margin-bottom: 10px; }
    #status { color: gray; font-size: 0.9em; margin-bottom: 10px; }
    #fileList { margin-top: 10px; font-size: 0.9em; }
  </style>
</head>
<body>
  <h2>üí¨ FastAPI WebSocket Chat <span id="userCount">(0 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)</span></h2>

  <div id="status">üîÑ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</div>
  <img id="avatarPreview" src="" alt="avatar" />
  <input id="username" placeholder="–í–∞—à–µ –∏–º—è" />
  <input id="msg" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ" />
  <label style="cursor: pointer;">
    üìé
    <input type="file" id="fileInput" multiple style="display: none;" />
  </label>
  <button onclick="send()" id="sendBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>

  <div id="fileList"></div>
  <ul id="messages"></ul>

  <script>
    let ws;
    let latitude = null;
    let longitude = null;
    const usernameInput = document.getElementById("username");
    const avatarPreview = document.getElementById("avatarPreview");
    const messages = document.getElementById("messages");
    const userCountSpan = document.getElementById("userCount");
    const statusDiv = document.getElementById("status");
    const fileInput = document.getElementById("fileInput");
    const fileListDiv = document.getElementById("fileList");
    const sendBtn = document.getElementById("sendBtn");

    let selectedFiles = [];

    // –£–∫–∞–∂–∏—Ç–µ –∑–¥–µ—Å—å –±–∞–∑–æ–≤—ã–π URL —Å–µ—Ä–≤–µ—Ä–∞ (—Ç–æ—Ç –∂–µ, —á—Ç–æ –∏ –≤ ngrok –∏–ª–∏ –≤–∞—à)
    const SERVER_BASE_URL = "https://a70f-35-243-189-32.ngrok-free.app";

    // Session & avatar
    let sessionId = localStorage.getItem("sessionId");
    if (!sessionId) {
      sessionId = crypto.randomUUID();
      localStorage.setItem("sessionId", sessionId);
    }

    usernameInput.value = localStorage.getItem("username") || "";
    usernameInput.addEventListener("input", () => {
      localStorage.setItem("username", usernameInput.value);
    });

    let avatarURL = localStorage.getItem("avatarURL");
    if (!avatarURL) {
      const avatarSeed = Math.random().toString(36).substring(2, 10);
      avatarURL = `https://api.dicebear.com/7.x/pixel-art/svg?seed=${avatarSeed}`;
      localStorage.setItem("avatarURL", avatarURL);
    }
    avatarPreview.src = avatarURL;

    // –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        latitude = pos.coords.latitude;
        longitude = pos.coords.longitude;
      },
      (err) => {
        console.warn("–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–ª—É—á–µ–Ω–∞:", err.message);
      },
      { enableHighAccuracy: true, timeout: 5000 }
    );

    // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ WebSocket
    function connectWebSocket() {
      ws = new WebSocket(SERVER_BASE_URL.replace(/^http/, 'ws') + "/ws/chat");
      ws.onopen = () => {
        statusDiv.textContent = "üü¢ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ";
        sendBtn.disabled = false;
        ws.send(JSON.stringify({
          sessionId,
          username: usernameInput.value || "–ê–Ω–æ–Ω–∏–º",
          latitude,
          longitude
        }));
      };

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);

        if (data.user_count !== undefined) {
          userCountSpan.textContent = `(${data.user_count} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å${data.user_count === 1 ? '' : '–µ–π'})`;
          return;
        }

        const distInfo = data.distance_km !== null ? ` (~${data.distance_km.toFixed(1)} –∫–º –æ—Ç –≤–∞—Å)` : '';

        const msg = document.createElement("li");

        const avatar = document.createElement("img");
        avatar.src = data.avatar || "";
        avatar.className = "avatar";

        const text = document.createElement("span");
        text.textContent = `[${data.timestamp}] ${data.username}: ${data.message}${distInfo}`;

        msg.appendChild(avatar);
        msg.appendChild(text);
        messages.appendChild(msg);
        msg.scrollIntoView({ behavior: "smooth" });
      };

      ws.onclose = () => {
        statusDiv.textContent = "üî¥ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ. –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞...";
        sendBtn.disabled = true;
        setTimeout(connectWebSocket, 3000);
      };

      ws.onerror = () => {
        statusDiv.textContent = "‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.";
        sendBtn.disabled = true;
      };
    }

    connectWebSocket();

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–æ–≤
    fileInput.addEventListener("change", (event) => {
      selectedFiles = Array.from(event.target.files);
      renderFileList();
    });

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤
    function renderFileList() {
      if (selectedFiles.length === 0) {
        fileListDiv.innerHTML = "";
        return;
      }

      const items = selectedFiles.map(f => `<li>${f.name} (${Math.round(f.size / 1024)} KB)</li>`);
      fileListDiv.innerHTML = `<b>üìé –ü—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:</b><ul>${items.join("")}</ul>`;
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ —Ñ–∞–π–ª–æ–≤
    async function send() {
      const username = usernameInput.value || "–ê–Ω–æ–Ω–∏–º";
      const message = document.getElementById("msg").value.trim();
      if (!message && selectedFiles.length === 0) return;

      const payload = {
        sessionId,
        username,
        message,
        latitude,
        longitude,
        avatar: avatarURL
      };

      if (ws.readyState !== WebSocket.OPEN) {
        alert("–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º.");
        return;
      }

      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ WebSocket
      ws.send(JSON.stringify(payload));

      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∞–π–ª—ã, –µ—Å–ª–∏ –µ—Å—Ç—å
      if (selectedFiles.length > 0) {
        const formData = new FormData();
        selectedFiles.forEach((file) => {
          formData.append("files", file);
        });
        formData.append("username", username);

        try {
          const response = await fetch(SERVER_BASE_URL + "/upload", {
            method: "POST",
            body: formData
          });
          if (!response.ok) {
            console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤:", response.statusText);
            alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤: " + response.statusText);
          }
        } catch (err) {
          console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤:", err);
          alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.");
        }
      }

      // –û—á–∏—Å—Ç–∫–∞
      document.getElementById("msg").value = "";
      fileInput.value = "";
      selectedFiles = [];
      renderFileList();
    }
  </script>
</body>
</html>
